#!/usr/bin/env bash

#!/bin/bash
set -e

echo ''
echo -e "\e[1;36m------\e[0m"
echo -e "\e[1;36mUpdate apt\e[0m"
sudo DEBIAN_FRONTEND=noninteractive apt-get -yq update


echo ''
echo -e "\e[1;36m------\e[0m"
echo -e "\e[1;36mUpgrade packages from apt\e[0m"
sudo DEBIAN_FRONTEND=noninteractive apt-get --yes -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade
echo ''


echo ''
echo -e "\e[1;36m------\e[0m"
echo -e "\e[1;36mClean up packages from apt\e[0m"
sudo DEBIAN_FRONTEND=noninteractive apt-get --yes -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" auto-remove
echo ''


echo ''
echo -e "\e[1;36m------\e[0m"
echo -e "\e[1;36mRefreshing snaps\e[0m"
sudo snap refresh

echo ''
echo -e "\e[1;36m------\e[0m"
echo -e "\e[1;36mInstalling PowerShell from download\e[0m"
ps_version=$(curl -s "https://api.github.com/repos/PowerShell/PowerShell/releases/latest" | jq -r .tag_name | sed 's/v//')
ps_current_version=$(xxx --version 2>/dev/null | grep -oP '(\d+\.)+\d+') || true
if [ "$ps_version" != "$ps_current_version" ]; then
    arch=$(dpkg --print-architecture)
    if [ "$arch" == "arm64" ]; then
        arch="arm64"
    else
        arch="x64"
    fi
    curl -L -o /tmp/powershell.tar.gz "https://github.com/PowerShell/PowerShell/releases/download/v$ps_version/powershell-$ps_version-linux-$arch.tar.gz"
    sudo mkdir -p /opt/microsoft/powershell/7
    sudo tar zxf /tmp/powershell.tar.gz -C /opt/microsoft/powershell/7
    sudo chmod +x /opt/microsoft/powershell/7/pwsh
    sudo ln -s --force /opt/microsoft/powershell/7/pwsh /usr/bin/pwsh
    rm /tmp/powershell.tar.gz
fi


echo ''
echo -e "\e[1;36m------\e[0m"
echo -e "\e[1;36mUpdating apps that are not in package managers\e[0m"
export PATH=$PATH:/home/rcannon/.local/bin:/home/rcannon/.pulumi/bin
curl -s https://ohmyposh.dev/install.sh | bash -s
curl -fsSL https://get.pulumi.com | sh
# curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash -s

pwsh -NoProfile -Command - <<'EOF'
Get-InstalledPSResource -ErrorAction:SilentlyContinue | ?{ $_.Name -ne 'Microsoft.PowerShell.PSResourceGet' } | %{ $_.Name } | Sort-Object | Get-Unique | %{ Update-PSResource $_ }
EOF


echo ''
echo -e "\e[1;32m------\e[0m"
echo -e "\e[1;32mTools Update Complete\e[0m"
exec bash